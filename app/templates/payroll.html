{% extends "index.html" %}

{% block content %}
<header>
    <h1>Payroll Calculation</h1>
    <p>Process monthly payroll for all active employees.</p>
</header>

<div class="card">
    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
        <label for="runDate">Process Date:</label>
        <select id="runDate" class="form-control" onchange="checkMode()">
            <option value="new">Run New Batch (Current Month)</option>
        </select>
        <button id="runBtn" class="btn-primary" onclick="runPayroll()">Process</button>
    </div>

    <div id="resultsArea" style="display: none;">
        <h3>Payroll Summary</h3>
        <div class="dashboard-stats" style="margin-bottom: 20px;">
            <div class="stat-box">
                <h5>Employees Processed</h5>
                <div class="stat-number" id="countVal">-</div>
            </div>
            <div class="stat-box">
                <h5>Total Expenditure</h5>
                <div class="stat-number" id="totalVal">-</div>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Gross Pay</th>
                    <th>Fed Tax (22%)</th>
                    <th>State Tax (5.75%)</th>
                    <th>Net Pay</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="payrollTable">
                <!-- Rows injected here -->
            </tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', loadDates);

    function loadDates() {
        fetch('/api/payroll/dates')
            .then(res => res.json())
            .then(dates => {
                const select = document.getElementById('runDate');
                dates.forEach(date => {
                    const opt = document.createElement('option');
                    opt.value = date;
                    opt.innerText = `View History: ${date}`;
                    select.appendChild(opt);
                });
            });
    }

    function checkMode() {
        const select = document.getElementById('runDate');
        const btn = document.getElementById('runBtn');
        if (select.value === 'new') {
            btn.innerText = 'Run New Batch';
            btn.classList.remove('btn-secondary');
            btn.classList.add('btn-primary');
        } else {
            btn.innerText = 'View Report';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-secondary');
        }
    }

    function runPayroll() {
        const btn = document.getElementById('runBtn');
        const select = document.getElementById('runDate');
        const mode = select.value === 'new' ? 'new' : 'view';
        const date = select.value === 'new' ? new Date().toISOString().split('T')[0] : select.value;

        btn.disabled = true;
        btn.innerHTML = `<span class="spinner" style="display:inline-block; width:12px; height:12px; border:2px solid #fff; border-top:2px solid transparent; border-radius:50%; animation: spin 1s linear infinite; margin-right:8px;"></span> ${mode === 'new' ? 'Calculating Payroll...' : 'Loading Report...'}`;

        // Add CSS for spinner if not exists
        if (!document.getElementById('payroll-spinner-style')) {
            const style = document.createElement('style');
            style.id = 'payroll-spinner-style';
            style.innerHTML = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
            document.head.appendChild(style);
        }

        fetch('/api/payroll', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode: mode, date: date })
        })
            .then(res => {
                if (!res.ok) throw new Error('Server returned ' + res.status);
                return res.json();
            })
            .then(data => {
                const table = document.getElementById('payrollTable');
                table.innerHTML = '';

                document.getElementById('countVal').innerText = data.total_processed;

                const formatter = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD'
                });
                document.getElementById('totalVal').innerText = formatter.format(data.total_expenditure);

                data.details.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row.id}</td>
                        <td>${row.name}</td>
                        <td>${formatter.format(row.gross_pay)}</td>
                        <td style="color: #64748b;">${formatter.format(row.fed_tax)}</td>
                        <td style="color: #64748b;">${formatter.format(row.state_tax)}</td>
                        <td style="font-weight: 700; color: var(--gmu-green);">${formatter.format(row.net_pay)}</td>
                        <td><span style="color: green;">âœ” ${mode === 'new' ? 'Processed' : 'Paid'}</span></td>
                    `;
                    table.appendChild(tr);
                });

                document.getElementById('resultsArea').style.display = 'block';
                checkMode(); // Reset button text
                btn.disabled = false;

                // If we just ran a new one, reload dropdown to show it
                if (mode === 'new') {
                    const select = document.getElementById('runDate');
                    select.innerHTML = '<option value="new">Run New Batch (Current Month)</option>';
                    loadDates();
                }
            })
            .catch(err => {
                console.error(err);
                alert('An error occurred during payroll processing: ' + err.message);
                btn.disabled = false;
                checkMode();
            });
    }
</script>
{% endblock %}